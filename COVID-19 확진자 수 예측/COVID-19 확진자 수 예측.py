# -*- coding: utf-8 -*-
"""201913301강미연_코로나19 확진자 수 예측.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Bouu_lKpri2e43Uw9DCsOyBu6fU9WGRp

# 머신러닝 모델을 이용한 대한민국 코로나19 신규 확진자 예측

## 라이브러리 불러오기
"""

import pandas as pd
import plotly.graph_objs as go
import plotly.offline as py
from fbprophet import Prophet
from fbprophet.plot import plot_plotly, add_changepoints_to_plot

import numpy as np

"""## 데이터 불러오기"""

# 코로나 19 한국 발생 현황
url = 'https://raw.githubusercontent.com/jooeungen/coronaboard_kr/master/kr_daily.csv'
df = pd.read_csv(url, error_bad_lines=False)
df.shape

df.info()

df.head(5)

df.tail(5)

df['confirmed']

"""## 전처리

### 결측치 확인
"""

df.isnull()

df.isnull().sum()

"""### 데이터 변환"""

df.info()

df=df.drop(['death', 'released', 'tested', 'negative', 'critical'], axis=1)
df.tail()

df['date'] = pd.to_datetime(df['date'],format='%Y%m%d')
df['date']

"""## 시각화

### Plot
"""

# 한국 코로나19 확진자 트렌드를 그래프로 만든다

fig = go.Figure()

fig.add_trace(
    go.Scatter(
        x=df.date,
        y=df.confirmed,
        name='Confirmed in Korea'
    )
)

fig

"""## 학습

### Facebook Prophet
"""

# Facebook Prophet 예측 모델에 넣을 데이터프레임을 만들어준다
df_prophet = df.rename(columns={
    'date': 'ds',
    'confirmed': 'y'
})

df_prophet.tail()

# Prophet에서 감안할 계절성을 선택해서 모델을 만든다
# changepoints을 추가하여 flexible 향상 (https://facebook.github.io/prophet/docs/trend_changepoints.html)

m = Prophet(
    changepoint_prior_scale=0.5, # trend를 더 flexible하게 만든다
    changepoint_range=0.95,
    yearly_seasonality=False,
    weekly_seasonality=True,
    daily_seasonality=True,
    seasonality_mode='additive'
)

m.fit(df_prophet)

future = m.make_future_dataframe(periods=7)

future.tail(7)

"""## 예측"""

forecast = m.predict(future)

# yhat : 예측값, yhat_lower : 오차를 고려한 예측 최소값, yhat_upper : 오차를 고려한 예측 최대값
forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']].tail(7)

"""### Plot Prediction"""

fig = plot_plotly(m, forecast)
py.iplot(fig)

"""### Plot changepoints"""

# changepoint를 그래프에 반영
fig = m.plot(forecast)
a = add_changepoints_to_plot(fig.gca(), m, forecast)